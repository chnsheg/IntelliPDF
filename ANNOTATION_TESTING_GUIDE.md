# 标注位置修复 - 测试指南

## 测试目的
验证标注坐标转换系统是否正确工作，确保在不同缩放级别和场景下标注位置准确。

## 前置条件

### 1. 启动服务
```powershell
# 后端
cd D:\IntelliPDF\backend
.\start.bat

# 前端（新窗口）
cd D:\IntelliPDF\frontend
npm run dev
```

### 2. 准备测试文件
- 使用现有的 PDF 文件（如 Linux教程.pdf 或论文.pdf）
- 确保文件已上传到系统

### 3. 打开浏览器开发者工具
- 按 F12 打开
- 切换到 Console 标签
- 准备观察坐标转换日志

---

## 测试场景

### 场景 1：100% 缩放（默认）

#### 步骤
1. 打开一个 PDF 文档
2. 选中一段文本（至少3个字符）
3. 点击工具栏的"高亮"按钮
4. 观察高亮区域是否准确覆盖选中文本

#### 预期结果
- ✅ 高亮区域完全覆盖选中的文本
- ✅ 上下左右边界对齐
- ✅ 不会覆盖到相邻文本

#### 如何验证
- 目视检查高亮区域
- 截图保存作为基准

---

### 场景 2：放大（150%）

#### 步骤
1. 点击放大按钮（或按 + 键）
2. 重复场景1的步骤
3. 同时检查之前创建的标注是否随缩放正确调整

#### 预期结果
- ✅ 新标注位置准确
- ✅ 已有标注随缩放正确调整
- ✅ 标注不会偏移或变形

---

### 场景 3：放大（200%）

#### 步骤
1. 继续放大到 200%
2. 创建新标注
3. 检查所有标注

#### 预期结果
- ✅ 所有标注（新旧）位置都准确
- ✅ 标注大小随缩放成比例调整

---

### 场景 4：缩小（50%）

#### 步骤
1. 缩小到 50%
2. 创建新标注
3. 检查所有标注

#### 预期结果
- ✅ 小尺寸下标注仍然可见
- ✅ 位置准确
- ✅ 不会重叠或丢失

---

### 场景 5：缩放切换

#### 步骤
1. 在 100% 创建标注
2. 放大到 150%，检查标注
3. 缩小到 75%，检查标注
4. 返回 100%，检查标注

#### 预期结果
- ✅ 标注在所有缩放级别下位置正确
- ✅ 无明显的抖动或跳跃
- ✅ 返回原始缩放时位置完全一致

---

### 场景 6：多页文档

#### 步骤
1. 在第1页创建标注
2. 切换到第5页创建标注
3. 切换到第10页创建标注
4. 返回查看第1页、第5页、第10页

#### 预期结果
- ✅ 每页标注只显示在对应页面
- ✅ 页面切换时标注不丢失
- ✅ 标注页码正确

---

### 场景 7：不同标注类型

#### 步骤
测试所有标注类型：
1. 高亮（黄色背景）
2. 下划线
3. 删除线
4. 生成标签（虚线边框）

#### 预期结果
- ✅ 每种类型都能正确渲染
- ✅ 位置都准确
- ✅ 样式符合预期

---

### 场景 8：长文本选择

#### 步骤
1. 选中跨越多行的长文本（5行以上）
2. 创建高亮标注
3. 检查每一行的高亮是否正确

#### 预期结果
- ✅ 每行高亮连续
- ✅ 第一行和最后一行的起始/结束位置正确
- ✅ 中间行完全覆盖

---

### 场景 9：页面边缘

#### 步骤
1. 选中页面顶部边缘的文本
2. 选中页面底部边缘的文本
3. 选中页面左侧边缘的文本
4. 选中页面右侧边缘的文本

#### 预期结果
- ✅ 边缘标注不被裁剪
- ✅ 工具栏不会超出可视区域
- ✅ 位置准确

---

### 场景 10：刷新页面

#### 步骤
1. 创建多个标注
2. 刷新浏览器（F5）
3. 等待页面加载完成
4. 检查标注是否恢复

#### 预期结果
- ✅ 标注从后端正确加载
- ✅ 位置和之前完全一致
- ✅ 所有标注类型都正确恢复

---

### 场景 11：切换阅读模式

#### 步骤
1. 在翻页模式创建标注
2. 切换到滚动模式
3. 检查标注
4. 切换回翻页模式

#### 预期结果
- ✅ 两种模式下标注都正确显示
- ✅ 模式切换不影响标注位置
- ✅ 标注不丢失

---

## 调试技巧

### 查看坐标转换日志

在浏览器控制台中，坐标转换过程会有日志输出。如果标注位置不正确，检查：

```javascript
// 查看 PDF 页面是否加载
console.log(pdfPagesCache.current);

// 查看坐标转换结果
// 应该在 handleSelection 和 AnnotationOverlay 中看到日志
```

### 手动测试坐标转换

在控制台中执行：

```javascript
// 获取 PDFViewerEnhanced 组件实例（通过 React DevTools）
// 然后手动调用坐标转换函数
```

### 检查 PDF 坐标

```javascript
// 在 createAnnotation 中添加日志
console.log('PDF coordinates:', { x, y, width, height });

// 在 AnnotationOverlay 中添加日志
console.log('Screen coordinates:', position);
```

---

## 常见问题排查

### 问题 1：标注位置偏移

**症状**：标注不在选中文本上，有明显偏移

**可能原因**：
- PDF 页面未加载完成
- 坐标转换失败（返回 null）
- viewport scale 不匹配

**排查步骤**：
1. 检查控制台是否有 "PDF page not available" 警告
2. 确认 `pdfDocumentRef.current` 不为 null
3. 检查 `getPDFPage` 是否成功返回页面对象

### 问题 2：标注不显示

**症状**：创建标注后什么都看不到

**可能原因**：
- 坐标转换返回 null，导致 `AnnotationOverlay` 不渲染
- 标注在视口外
- Z-index 被其他元素遮挡

**排查步骤**：
1. 检查 `AnnotationOverlay` 的 useEffect 是否执行
2. 查看 `position` state 是否有值
3. 检查 DOM 中是否有标注元素

### 问题 3：缩放后标注不更新

**症状**：改变缩放级别后，标注位置仍然是旧的

**可能原因**：
- `AnnotationOverlay` 的 useEffect 依赖项不完整
- scale 变化未触发重新计算

**解决方法**：
确认 useEffect 依赖项包含 `[annotation, pageNum, scale]`

### 问题 4：工具栏位置不对

**症状**：工具栏显示在错误的位置

**可能原因**：
- `toolbarX` / `toolbarY` 未正确设置
- 降级到使用 PDF 坐标（应该用屏幕坐标）

**解决方法**：
检查 `handleSelection` 是否正确设置了 `toolbarX` 和 `toolbarY`

---

## 性能测试

### 测试大量标注

1. 创建 50 个标注
2. 切换缩放级别
3. 观察是否有卡顿

#### 预期结果
- ✅ 渲染流畅，无明显延迟
- ✅ 页面缓存机制生效（不重复加载）

### 测试快速缩放

1. 快速连续点击放大/缩小按钮
2. 观察标注更新是否及时

#### 预期结果
- ✅ 标注平滑更新
- ✅ 无闪烁或撕裂

---

## 测试记录表

| 场景 | 通过 | 失败 | 备注 |
|------|------|------|------|
| 100% 缩放 | ☐ | ☐ | |
| 150% 缩放 | ☐ | ☐ | |
| 200% 缩放 | ☐ | ☐ | |
| 50% 缩放 | ☐ | ☐ | |
| 缩放切换 | ☐ | ☐ | |
| 多页文档 | ☐ | ☐ | |
| 不同标注类型 | ☐ | ☐ | |
| 长文本选择 | ☐ | ☐ | |
| 页面边缘 | ☐ | ☐ | |
| 刷新页面 | ☐ | ☐ | |
| 切换阅读模式 | ☐ | ☐ | |
| 大量标注性能 | ☐ | ☐ | |
| 快速缩放性能 | ☐ | ☐ | |

---

## 测试报告模板

```markdown
# 标注位置测试报告

**测试日期**：YYYY-MM-DD
**测试人员**：
**PDF 文件**：
**浏览器**：Chrome/Firefox/Edge 版本号

## 测试结果总结
- 通过：X / 13
- 失败：Y / 13

## 失败场景详情
### 场景 X：描述
- **现象**：
- **预期**：
- **实际**：
- **截图**：
- **控制台日志**：

## 性能评估
- 渲染速度：快/中/慢
- 内存占用：正常/偏高
- CPU 占用：正常/偏高

## 建议
1. 
2. 
3. 

## 总体评价
□ 可以发布
□ 需要修复后再测试
□ 重大问题，需要重新实现
```

---

## 下一步

测试通过后：
1. ✅ 更新 TODO 状态
2. ✅ 创建 Git 提交
3. ✅ 开始 Phase 2（优化和完善）

测试失败：
1. ❌ 记录详细的失败场景
2. ❌ 分析根本原因
3. ❌ 修复代码
4. ❌ 重新测试

---

**创建时间**：2025-10-08  
**版本**：v1.0  
**状态**：待测试
