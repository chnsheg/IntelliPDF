# 新图形工具测试指南

## 🎯 测试目标
验证新增的三种动态图形标注工具：
1. **矩形工具** - 动态拖拽绘制矩形
2. **圆形工具** - 动态拖拽绘制椭圆/圆形
3. **箭头工具** - 动态拖拽绘制带箭头的线条

## 📋 前置条件
- ✅ 后端运行中 (http://localhost:8000)
- ✅ 前端运行中 (http://localhost:5173)
- ✅ 已上传测试 PDF 文档

## 🔧 新功能说明

### 1. 矩形工具 (Rectangle)
**工具栏按钮**: 🔲 矩形 (正方形图标)

**使用方式**:
1. 点击工具栏中的"矩形"按钮
2. 在 PDF 页面上按住鼠标左键并拖拽
3. **实时预览**: 拖拽过程中会显示矩形轮廓
4. 释放鼠标完成绘制
5. 矩形会自动保存到后端

**数据结构**:
```typescript
{
  annotationType: 100,  // RECTANGLE
  pageIndex: 0,
  rect: [x1, y1, x2, y2],
  color: [r, g, b],  // 0-1 范围
  thickness: 1-5
}
```

### 2. 圆形工具 (Circle)
**工具栏按钮**: ⭕ 圆形 (圆圈图标)

**使用方式**:
1. 点击工具栏中的"圆形"按钮
2. 在 PDF 页面上按住鼠标左键并拖拽
3. **实时预览**: 拖拽过程中会显示椭圆轮廓
4. 释放鼠标完成绘制
5. 圆形会自动保存到后端

**数据结构**:
```typescript
{
  annotationType: 101,  // CIRCLE
  pageIndex: 0,
  center: [cx, cy],
  radius: [rx, ry],  // 支持椭圆
  color: [r, g, b],
  thickness: 1-5
}
```

### 3. 箭头工具 (Arrow)
**工具栏按钮**: ↗ 箭头 (箭头图标)

**使用方式**:
1. 点击工具栏中的"箭头"按钮
2. 在 PDF 页面上按住鼠标左键并拖拽
3. **实时预览**: 拖拽过程中会显示箭头（线条+箭头头部）
4. 释放鼠标完成绘制
5. 箭头会自动保存到后端

**数据结构**:
```typescript
{
  annotationType: 102,  // ARROW
  pageIndex: 0,
  start: [x1, y1],
  end: [x2, y2],
  color: [r, g, b],
  thickness: 1-5
}
```

## ✅ 测试步骤

### 步骤 1: 基础功能测试
1. 打开浏览器访问 http://localhost:5173
2. 上传一个 PDF 文档
3. 等待文档加载完成

### 步骤 2: 测试矩形工具
1. 点击工具栏的"矩形"按钮
2. 在 PDF 上拖拽绘制一个矩形
3. **验证**:
   - ✅ 拖拽时能看到实时预览
   - ✅ 释放后矩形保持显示
   - ✅ 刷新页面后矩形仍然存在
4. 选择不同颜色（红、蓝、绿、黄、紫、橙）
5. 选择不同粗细（1-5）
6. 再次绘制验证颜色和粗细生效

### 步骤 3: 测试圆形工具
1. 点击工具栏的"圆形"按钮
2. 在 PDF 上拖拽绘制一个圆形
3. **验证**:
   - ✅ 拖拽时能看到实时预览
   - ✅ 释放后圆形保持显示
   - ✅ 支持椭圆（横向/纵向拖拽）
   - ✅ 刷新页面后圆形仍然存在
4. 测试不同颜色和粗细

### 步骤 4: 测试箭头工具
1. 点击工具栏的"箭头"按钮
2. 在 PDF 上拖拽绘制一个箭头
3. **验证**:
   - ✅ 拖拽时能看到实时预览（线条+箭头头部）
   - ✅ 释放后箭头保持显示
   - ✅ 箭头头部朝向正确（指向拖拽终点）
   - ✅ 刷新页面后箭头仍然存在
4. 测试不同方向的箭头（上、下、左、右、斜向）
5. 测试不同颜色和粗细

### 步骤 5: 混合工具测试
1. 在同一页面上使用所有工具
2. 创建: 2个矩形 + 2个圆形 + 2个箭头 + 1个手绘 + 1个文本
3. **验证**:
   - ✅ 所有标注都正确显示
   - ✅ 没有图层冲突
   - ✅ 刷新页面后全部恢复

### 步骤 6: 选择和删除测试
1. 点击"选择"按钮
2. 点击任意一个新图形标注
3. **验证**:
   - ✅ 标注显示蓝色边框（选中状态）
4. 按 Delete 或 Backspace 键
5. **验证**:
   - ✅ 标注被删除
   - ✅ 后端数据也被删除（刷新验证）

### 步骤 7: 跨页面测试
1. 切换到第 2 页
2. 绘制新的图形标注
3. 切回第 1 页
4. **验证**:
   - ✅ 第 1 页的标注仍然存在
   - ✅ 第 2 页的标注不显示在第 1 页
5. 再切到第 2 页验证标注正确显示

## 🐛 已知问题修复

### ✅ 问题 1: 标注不显示
**原因**: RGB 颜色转换错误  
**修复**: `color[0] * 255` 替代 `color.join(',')`  
**状态**: 已修复

### ✅ 问题 2: SVG 定位错误
**原因**: 缺少 left/top 定位  
**修复**: 添加完整的定位样式  
**状态**: 已修复

### ✅ 问题 3: 旧标注系统冲突
**原因**: 旧组件仍然存在  
**修复**: 测试页面已使用新组件  
**状态**: 部分修复（旧代码文件仍存在，待删除）

## 🎨 UI/UX 特性

### 颜色选择器
- 6 种预设颜色: 红、蓝、绿、黄、紫、橙
- 点击色块切换颜色
- 当前颜色显示外边框高亮

### 粗细选择器
- 5 档粗细: 1px, 2px, 3px, 4px, 5px
- 横向排列，数字显示
- 当前粗细背景高亮

### 实时预览
- 所有新图形工具支持拖拽实时预览
- 预览使用当前选择的颜色和粗细
- 释放鼠标后立即保存

### Z-Index 层级
```
Canvas Layer (0) - PDF 内容
TextLayer (5) - 文本选择层
AnnotationLayer (10) - 已保存标注
saved-annotation (15) - 单个标注元素
EditorLayer (20) - 新标注编辑
```

## 📊 技术实现细节

### PDF.js 标注类型
```typescript
enum AnnotationEditorType {
  INK = 15,        // 手绘 (PDF.js 原生)
  FREETEXT = 3,    // 文本 (PDF.js 原生)
  STAMP = 13,      // 图章 (PDF.js 原生)
  RECTANGLE = 100, // 矩形 (自定义扩展)
  CIRCLE = 101,    // 圆形 (自定义扩展)
  ARROW = 102,     // 箭头 (自定义扩展)
}
```

### 动态绘制机制
1. **mousedown**: 记录起点坐标，创建 SVG 容器
2. **mousemove**: 计算当前坐标，更新预览形状
3. **mouseup**: 保存标注数据到 annotationStorage
4. **自动触发**: saveAnnotations() 批量提交到后端

### 数据流
```
用户操作 → SVG 预览 → annotationStorage → POST /batch → 后端数据库
                                              ↓
                      页面刷新 ← renderSavedAnnotations ← GET /documents/:id
```

## 🔍 调试信息

### 浏览器控制台日志
```javascript
[RectangleEditor] Created annotation: {...}  // 矩形创建
[CircleEditor] Created annotation: {...}     // 圆形创建
[ArrowEditor] Created annotation: {...}      // 箭头创建
```

### 检查 annotationStorage
```javascript
// 在浏览器控制台执行
console.log(window.pdfDocument?.annotationStorage.serializable)
```

### 网络请求
- POST http://localhost:8000/api/v1/annotations/batch
- GET http://localhost:8000/api/v1/annotations/documents/:id

## 📝 下一步计划

### 待完成任务
1. ⏳ 删除旧标注系统代码 (~1780 行)
2. ⏳ 添加标注编辑功能（修改颜色、粗细、位置）
3. ⏳ 添加标注撤销/重做功能
4. ⏳ 优化大量标注的渲染性能
5. ⏳ 添加标注导出功能（PDF、JSON）

### 可选增强
- 添加更多图形工具（多边形、曲线、高亮）
- 支持标注分组和图层管理
- 添加标注搜索和筛选
- 支持协同标注（多用户）

## ✅ 测试清单

- [ ] 矩形工具基础功能
- [ ] 矩形工具颜色切换
- [ ] 矩形工具粗细切换
- [ ] 矩形工具实时预览
- [ ] 矩形工具数据持久化
- [ ] 圆形工具基础功能
- [ ] 圆形工具支持椭圆
- [ ] 圆形工具颜色和粗细
- [ ] 箭头工具基础功能
- [ ] 箭头工具方向正确
- [ ] 箭头工具箭头头部渲染
- [ ] 混合工具不冲突
- [ ] 选择和删除功能
- [ ] 跨页面标注隔离
- [ ] 页面刷新数据恢复

---

**测试日期**: 2024-01-XX  
**测试人员**: [Your Name]  
**测试结果**: [通过/失败]  
**备注**: [填写测试中发现的问题]
