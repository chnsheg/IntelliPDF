<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•å›¾å½¢æ ‡æ³¨æ¸²æŸ“</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .test-section h2 {
            color: #333;
            border-bottom: 2px solid #2196F3;
            padding-bottom: 10px;
        }

        .step {
            margin: 15px 0;
            padding: 15px;
            background: #f9f9f9;
            border-left: 4px solid #2196F3;
        }

        .step h3 {
            margin: 0 0 10px 0;
            color: #2196F3;
        }

        .code {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
        }

        .success {
            color: #4CAF50;
            font-weight: bold;
        }

        .warning {
            color: #FF9800;
            font-weight: bold;
        }

        .error {
            color: #F44336;
            font-weight: bold;
        }

        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }

        button:hover {
            background: #1976D2;
        }

        #result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            display: none;
        }

        #result.success {
            background: #E8F5E9;
            border: 1px solid #4CAF50;
        }

        #result.error {
            background: #FFEBEE;
            border: 1px solid #F44336;
        }
    </style>
</head>

<body>
    <h1>ğŸ¨ å›¾å½¢æ ‡æ³¨æ¸²æŸ“åŠŸèƒ½æµ‹è¯•</h1>

    <div class="test-section">
        <h2>ğŸ“‹ æµ‹è¯•è¯´æ˜</h2>
        <p>æœ¬é¡µé¢ç”¨äºæµ‹è¯• IntelliPDF çš„å›¾å½¢æ ‡æ³¨æ¸²æŸ“åŠŸèƒ½ã€‚</p>
        <p><strong>å‰ææ¡ä»¶</strong>ï¼š</p>
        <ul>
            <li>âœ… å‰ç«¯æœåŠ¡å™¨è¿è¡Œåœ¨ <code>http://localhost:5174</code></li>
            <li>âœ… åç«¯æœåŠ¡å™¨è¿è¡Œåœ¨ <code>http://localhost:8000</code></li>
            <li>âœ… æ•°æ®åº“å·²åŒ…å«å›¾å½¢æ ‡æ³¨æ•°æ®</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>ğŸ”¬ æ‰‹åŠ¨æµ‹è¯•æ­¥éª¤</h2>

        <div class="step">
            <h3>æ­¥éª¤ 1: æ‰“å¼€åº”ç”¨</h3>
            <p>1. åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ <a href="http://localhost:5174" target="_blank">http://localhost:5174</a></p>
            <p>2. é€‰æ‹©å·²ä¸Šä¼ çš„ PDF æ–‡æ¡£ï¼ˆä¾‹å¦‚ï¼šLinuxæ•™ç¨‹.pdf æˆ– è®ºæ–‡.pdfï¼‰</p>
        </div>

        <div class="step">
            <h3>æ­¥éª¤ 2: ç»˜åˆ¶å›¾å½¢æ ‡æ³¨</h3>
            <p>1. ç‚¹å‡»å·¦ä¾§å·¥å…·æ çš„<strong>"çŸ©å½¢"</strong>æŒ‰é’®</p>
            <p>2. åœ¨ PDF é¡µé¢ä¸Šæ‹–æ‹½é¼ æ ‡ç»˜åˆ¶çŸ©å½¢</p>
            <p>3. é‡Šæ”¾é¼ æ ‡ï¼Œæ ‡æ³¨åº”è‡ªåŠ¨ä¿å­˜</p>
            <p>4. é‡å¤æµ‹è¯•<strong>"åœ†å½¢"</strong>å’Œ<strong>"ç®­å¤´"</strong>å·¥å…·</p>
        </div>

        <div class="step">
            <h3>æ­¥éª¤ 3: éªŒè¯æ¸²æŸ“</h3>
            <p><strong class="success">âœ… æˆåŠŸæ ‡å¿—</strong>ï¼š</p>
            <ul>
                <li>ç»˜åˆ¶çš„å›¾å½¢ç«‹å³æ˜¾ç¤ºåœ¨ PDF ä¸Š</li>
                <li>å›¾å½¢é¢œè‰²ä¸ºè“è‰² (#2196F3)</li>
                <li>å›¾å½¢åŠé€æ˜å¡«å……ï¼ˆopacity 0.2ï¼‰</li>
                <li>åˆ·æ–°é¡µé¢åå›¾å½¢ä»ç„¶æ˜¾ç¤º</li>
            </ul>
            <p><strong class="error">âŒ å¤±è´¥æ ‡å¿—</strong>ï¼š</p>
            <ul>
                <li>ç»˜åˆ¶åå›¾å½¢æ¶ˆå¤±</li>
                <li>åˆ·æ–°é¡µé¢åå›¾å½¢ä¸æ˜¾ç¤º</li>
                <li>æ§åˆ¶å°å‡ºç°é”™è¯¯</li>
            </ul>
        </div>

        <div class="step">
            <h3>æ­¥éª¤ 4: æ£€æŸ¥æ§åˆ¶å°</h3>
            <p>æŒ‰ <code>F12</code> æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œæ£€æŸ¥ï¼š</p>
            <p>1. <strong>Console</strong> æ ‡ç­¾ï¼šæŸ¥çœ‹æ—¥å¿—ä¿¡æ¯</p>
            <div class="code">
                // åº”è¯¥çœ‹åˆ°ç±»ä¼¼çš„æ—¥å¿—ï¼š
                Loaded 3 annotations from backend
                Created annotation shape-xxx for document yyy
            </div>
            <p>2. <strong>Network</strong> æ ‡ç­¾ï¼šéªŒè¯ API è¯·æ±‚</p>
            <ul>
                <li>âœ… <code>GET /api/v1/annotations/documents/{id}</code> - è¿”å› 200</li>
                <li>âœ… <code>POST /api/v1/annotations/</code> - è¿”å› 201</li>
            </ul>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ” API æµ‹è¯•</h2>
        <p>ä½¿ç”¨ä»¥ä¸‹æŒ‰é’®æµ‹è¯•åç«¯ APIï¼š</p>
        <button onclick="testGetDocuments()">è·å–æ–‡æ¡£åˆ—è¡¨</button>
        <button onclick="testGetAnnotations()">è·å–æ ‡æ³¨åˆ—è¡¨</button>
        <button onclick="testCreateShape()">åˆ›å»ºæµ‹è¯•å›¾å½¢</button>
        <div id="result"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“Š é¢„æœŸæ•°æ®æ ¼å¼</h2>
        <p><strong>åç«¯è¿”å›çš„æ ‡æ³¨æ•°æ®ï¼š</strong></p>
        <div class="code">
            {
            "annotations": [
            {
            "id": "3953e068-94cb-4ac0-8b80-235187dc30e7",
            "document_id": "8523c731-ccea-4137-8472-600dcb5f4b64",
            "user_id": "test_user",
            "annotation_type": "shape",
            "page_number": 1,
            "data": {
            "id": "shape-test-rectangle",
            "type": "shape",
            "shapeType": "rectangle",
            "geometry": {
            "rect": { "x": 100, "y": 200, "width": 150, "height": 80 }
            },
            "style": {
            "color": "#2196F3",
            "opacity": 0.8,
            "strokeWidth": 2,
            "fillColor": "#2196F3",
            "fillOpacity": 0.2
            }
            },
            "created_at": "2025-10-08T19:31:00",
            "updated_at": "2025-10-08T19:31:00"
            }
            ],
            "total": 1
            }
        </div>

        <p><strong>è½¬æ¢åçš„å‰ç«¯æ ¼å¼ï¼š</strong></p>
        <div class="code">
            {
            "id": "shape-test-rectangle",
            "type": "shape",
            "pageNumber": 1,
            "geometry": {
            "rect": { "x": 100, "y": 200, "width": 150, "height": 80 }
            },
            "style": {
            "type": "rectangle",
            "color": "#2196F3",
            "opacity": 0.8,
            "strokeWidth": 2,
            "fillColor": "#2196F3",
            "fillOpacity": 0.2,
            "lineStyle": "solid"
            },
            "metadata": {
            "createdAt": "2025-10-08T19:31:00",
            "updatedAt": "2025-10-08T19:31:00",
            "userId": "test_user",
            "userName": "Anonymous"
            }
            }
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ› å¸¸è§é—®é¢˜</h2>

        <h3>é—®é¢˜ 1: å›¾å½¢ä¸æ˜¾ç¤º</h3>
        <p><strong>åŸå› </strong>ï¼šæ•°æ®æ ¼å¼ä¸åŒ¹é…æˆ–åæ ‡è½¬æ¢é”™è¯¯</p>
        <p><strong>è§£å†³</strong>ï¼š</p>
        <ul>
            <li>æ£€æŸ¥ <code>transformBackendAnnotation</code> å‡½æ•°</li>
            <li>éªŒè¯ <code>geometry</code> å’Œ <code>style.type</code> å­—æ®µ</li>
            <li>æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯ä¿¡æ¯</li>
        </ul>

        <h3>é—®é¢˜ 2: åˆ·æ–°åå›¾å½¢æ¶ˆå¤±</h3>
        <p><strong>åŸå› </strong>ï¼šæœªä»åç«¯åŠ è½½æ ‡æ³¨</p>
        <p><strong>è§£å†³</strong>ï¼š</p>
        <ul>
            <li>ç¡®è®¤ <code>loadAnnotations</code> å‡½æ•°è¢«è°ƒç”¨</li>
            <li>æ£€æŸ¥ API å“åº”æ•°æ®</li>
            <li>éªŒè¯ <code>setAnnotations</code> è¢«æ­£ç¡®è°ƒç”¨</li>
        </ul>

        <h3>é—®é¢˜ 3: å›¾å½¢ä½ç½®ä¸æ­£ç¡®</h3>
        <p><strong>åŸå› </strong>ï¼šåæ ‡ç³»ç»Ÿä¸åŒ¹é…</p>
        <p><strong>è§£å†³</strong>ï¼š</p>
        <ul>
            <li>ç¡®è®¤ä½¿ç”¨ PDF åæ ‡ï¼ˆorigin: bottom-leftï¼‰</li>
            <li>æ£€æŸ¥ <code>pdfCoordinateService.rectangleToScreen</code></li>
            <li>éªŒè¯ <code>viewport</code> ç¼©æ”¾æ¯”ä¾‹</li>
        </ul>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';

        async function testGetDocuments() {
            const result = document.getElementById('result');
            result.style.display = 'block';
            result.className = '';
            result.innerHTML = 'â³ æ­£åœ¨è·å–æ–‡æ¡£åˆ—è¡¨...';

            try {
                const response = await fetch(`${API_BASE}/documents/`);
                const data = await response.json();

                if (data.documents && data.documents.length > 0) {
                    result.className = 'success';
                    result.innerHTML = `
                        <strong class="success">âœ… æˆåŠŸ</strong><br>
                        æ‰¾åˆ° ${data.documents.length} ä¸ªæ–‡æ¡£ï¼š<br>
                        ${data.documents.map(doc => `- ${doc.filename} (ID: ${doc.id})`).join('<br>')}
                    `;
                } else {
                    result.className = 'error';
                    result.innerHTML = '<strong class="error">âŒ é”™è¯¯</strong><br>æœªæ‰¾åˆ°æ–‡æ¡£';
                }
            } catch (error) {
                result.className = 'error';
                result.innerHTML = `<strong class="error">âŒ é”™è¯¯</strong><br>${error.message}`;
            }
        }

        async function testGetAnnotations() {
            const result = document.getElementById('result');
            result.style.display = 'block';
            result.className = '';
            result.innerHTML = 'â³ æ­£åœ¨è·å–æ ‡æ³¨åˆ—è¡¨...';

            try {
                // å…ˆè·å–æ–‡æ¡£åˆ—è¡¨
                const docResp = await fetch(`${API_BASE}/documents/`);
                const docData = await docResp.json();

                if (!docData.documents || docData.documents.length === 0) {
                    result.className = 'error';
                    result.innerHTML = '<strong class="error">âŒ é”™è¯¯</strong><br>æœªæ‰¾åˆ°æ–‡æ¡£';
                    return;
                }

                const docId = docData.documents[0].id;

                // è·å–æ ‡æ³¨
                const annResp = await fetch(`${API_BASE}/annotations/documents/${docId}`);
                const annData = await annResp.json();

                const shapeCount = annData.annotations ?
                    annData.annotations.filter(a => a.annotation_type === 'shape').length : 0;

                result.className = 'success';
                result.innerHTML = `
                    <strong class="success">âœ… æˆåŠŸ</strong><br>
                    æ–‡æ¡£ ID: ${docId}<br>
                    æ€»æ ‡æ³¨æ•°: ${annData.total || 0}<br>
                    å›¾å½¢æ ‡æ³¨æ•°: ${shapeCount}<br>
                    <details>
                        <summary>æŸ¥çœ‹æ•°æ®</summary>
                        <pre style="background:#263238;color:#aed581;padding:10px;overflow:auto;">${JSON.stringify(annData, null, 2)}</pre>
                    </details>
                `;
            } catch (error) {
                result.className = 'error';
                result.innerHTML = `<strong class="error">âŒ é”™è¯¯</strong><br>${error.message}`;
            }
        }

        async function testCreateShape() {
            const result = document.getElementById('result');
            result.style.display = 'block';
            result.className = '';
            result.innerHTML = 'â³ æ­£åœ¨åˆ›å»ºæµ‹è¯•å›¾å½¢...';

            try {
                // å…ˆè·å–æ–‡æ¡£ ID
                const docResp = await fetch(`${API_BASE}/documents/`);
                const docData = await docResp.json();

                if (!docData.documents || docData.documents.length === 0) {
                    result.className = 'error';
                    result.innerHTML = '<strong class="error">âŒ é”™è¯¯</strong><br>æœªæ‰¾åˆ°æ–‡æ¡£';
                    return;
                }

                const docId = docData.documents[0].id;

                // åˆ›å»ºæµ‹è¯•å›¾å½¢
                const annotationData = {
                    document_id: docId,
                    user_id: 'test_user_' + Date.now(),
                    annotation_type: 'shape',
                    page_number: 1,
                    data: {
                        id: 'shape-test-' + Date.now(),
                        type: 'shape',
                        shapeType: 'rectangle',
                        geometry: {
                            rect: {
                                x: Math.random() * 400 + 50,
                                y: Math.random() * 400 + 50,
                                width: 150,
                                height: 80
                            }
                        },
                        style: {
                            color: '#2196F3',
                            opacity: 0.8,
                            strokeWidth: 2,
                            fillColor: '#2196F3',
                            fillOpacity: 0.2
                        }
                    },
                    tags: ['test']
                };

                const createResp = await fetch(`${API_BASE}/annotations/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(annotationData)
                });

                if (createResp.ok) {
                    const created = await createResp.json();
                    result.className = 'success';
                    result.innerHTML = `
                        <strong class="success">âœ… æˆåŠŸ</strong><br>
                        åˆ›å»ºçš„æ ‡æ³¨ ID: ${created.id}<br>
                        ç±»å‹: ${created.annotation_type}<br>
                        é¡µç : ${created.page_number}<br>
                        <strong>è¯·åˆ·æ–°å‰ç«¯é¡µé¢æŸ¥çœ‹æ•ˆæœï¼</strong>
                    `;
                } else {
                    const error = await createResp.text();
                    result.className = 'error';
                    result.innerHTML = `<strong class="error">âŒ é”™è¯¯</strong><br>${error}`;
                }
            } catch (error) {
                result.className = 'error';
                result.innerHTML = `<strong class="error">âŒ é”™è¯¯</strong><br>${error.message}`;
            }
        }
    </script>
</body>

</html>