# 书签系统前端集成测试指南

## 测试环境
- **前端**: http://localhost:5174
- **后端**: http://localhost:8000
- **日期**: 2025-01-XX

## 已完成的集成工作

### 1. DocumentViewerPage 集成 ✅
- ✅ 导入 `BookmarkPanel` 组件
- ✅ 添加书签面板开关状态 (`bookmarkOpen`)
- ✅ 添加文本选择状态 (`selectedText`, `selectedTextPosition`)
- ✅ 集成书签数据获取 (React Query)
- ✅ 实现所有回调函数:
  - `handleTextSelected` - 处理 PDF 文本选择
  - `handleBookmarkClick` - 书签点击跳转
  - `handleBookmarkCreated` - 书签创建后刷新
  - `handleJumpToBookmark` - 从书签面板跳转

### 2. PDFViewerEnhanced 连接 ✅
- ✅ 传递 `bookmarks` prop (从 React Query 获取)
- ✅ 传递 `onTextSelected` 回调
- ✅ 传递 `onBookmarkClick` 回调
- ✅ 保留 `chunks` 数据传递

### 3. ChatPanel 增强 ✅
- ✅ 传递 `selectedText` prop
- ✅ 传递 `selectedTextPosition` prop
- ✅ 传递 `onBookmarkCreated` 回调

### 4. UI 布局改进 ✅
- ✅ 添加书签面板切换按钮 (头部工具栏)
- ✅ 三栏布局: 书签面板 + PDF + 聊天面板
- ✅ 移动端支持: 浮动按钮 + 全屏覆盖
- ✅ 响应式设计: 桌面/移动自适应

## 测试步骤

### 测试前准备
1. 确认后端运行: `http://localhost:8000/health`
2. 确认前端运行: `http://localhost:5174`
3. 打开浏览器开发者工具 (F12) 查看控制台

### 场景 1: 上传文档并查看
**预期结果**: 文档上传成功,可正常浏览 PDF

1. 访问 http://localhost:5174
2. 点击"上传文档"或"开始使用"
3. 选择测试 PDF (如 `论文.pdf`)
4. 等待上传和处理完成
5. 自动跳转到文档查看页面

**验证点**:
- ✅ PDF 正确显示
- ✅ 可以翻页
- ✅ 可以缩放

### 场景 2: 书签面板显示
**预期结果**: 书签面板可正常打开/关闭

1. 在文档查看页面,点击头部 **书签图标** (📖)
2. 左侧应出现书签面板
3. 再次点击图标关闭面板

**验证点**:
- ✅ 书签面板正确显示/隐藏
- ✅ 面板显示"暂无书签"(如果是新文档)
- ✅ 面板布局正常,无遮挡

### 场景 3: 文本选择 → AI 生成书签
**预期结果**: 选中文本后可通过 AI 生成书签

**步骤**:
1. 在 PDF 中**用鼠标选中一段文字** (约 1-2 句)
2. 聊天面板应自动打开 (如果关闭)
3. 查看聊天输入框上方是否显示:
   - "已选择文本: ..."
   - **"生成书签"按钮** (紫色/蓝色)
4. 点击"生成书签"按钮
5. 等待 AI 处理 (显示加载动画)
6. 成功后应显示提示消息

**验证点**:
- ✅ 文本选择被正确检测
- ✅ 聊天面板显示选中文本
- ✅ "生成书签"按钮可见且可点击
- ✅ AI 请求成功 (查看 Network 面板: POST `/bookmarks/generate`)
- ✅ 书签创建成功 (201 响应)
- ✅ 书签面板自动刷新并显示新书签

### 场景 4: 书签列表功能
**预期结果**: 书签面板显示所有书签,支持交互

1. 打开书签面板 (如果已关闭)
2. 查看书签列表内容

**验证点**:
- ✅ 显示书签标题 (AI 生成)
- ✅ 显示页码
- ✅ 显示 AI 摘要 (折叠/展开)
- ✅ 显示标签 (如果有)
- ✅ 每个书签有操作按钮:
  - 📖 跳转
  - ✏️ 编辑
  - 🗑️ 删除

### 场景 5: 书签跳转
**预期结果**: 点击书签后 PDF 自动跳转到对应页码

1. 在书签列表中点击书签标题或"跳转"按钮
2. PDF 应自动跳转到书签所在页面
3. (高级) 页面应滚动到书签精确位置

**验证点**:
- ✅ PDF 正确跳转到书签页码
- ✅ 当前页码指示器更新

### 场景 6: 书签编辑
**预期结果**: 可编辑书签标题和笔记

1. 点击书签右侧的 **编辑图标** (✏️)
2. 书签卡片进入编辑模式
3. 修改标题或添加笔记
4. 点击 **保存图标** (💾)

**验证点**:
- ✅ 编辑模式正常切换
- ✅ 输入框显示当前内容
- ✅ 保存请求成功 (PUT `/bookmarks/{id}`)
- ✅ 界面立即更新显示新内容

### 场景 7: 书签删除
**预期结果**: 可删除书签

1. 点击书签右侧的 **删除图标** (🗑️)
2. (可选) 弹出确认对话框
3. 确认删除

**验证点**:
- ✅ 删除请求成功 (DELETE `/bookmarks/{id}`)
- ✅ 书签从列表中移除
- ✅ 页面无需刷新即更新

### 场景 8: 书签搜索和排序
**预期结果**: 书签列表支持搜索和排序

1. 在书签面板顶部找到 **搜索框**
2. 输入关键词 (如标题或摘要中的词)
3. 书签列表实时过滤
4. 点击 **排序按钮** 切换排序方式:
   - 按页码
   - 按创建时间
   - 按标题

**验证点**:
- ✅ 搜索实时生效
- ✅ 排序正确工作
- ✅ 清空搜索后恢复完整列表

### 场景 9: AI 对话 (与书签独立)
**预期结果**: AI 聊天功能正常,不受书签影响

1. 在聊天面板输入框输入问题 (如"总结这个文档")
2. 点击发送
3. 等待 AI 回复

**验证点**:
- ✅ 问题正确发送 (POST `/documents/{id}/chat`)
- ✅ AI 回复正确显示
- ✅ 可复制回复内容
- ✅ 显示相关来源 (如有)

### 场景 10: 分块边界可视化
**预期结果**: PDF 上显示文档分块边界

1. 在 PDF 查看器工具栏找到 **"显示分块"按钮** (👁️)
2. 点击切换显示/隐藏
3. PDF 上应显示彩色矩形框标记分块区域

**验证点**:
- ✅ 分块边界正确显示
- ✅ 不同分块使用不同颜色
- ✅ 点击分块触发高亮 (如实现)

### 场景 11: 书签覆盖层显示
**预期结果**: PDF 上显示书签位置标记

1. 创建至少一个书签
2. 在 PDF 查看器上应显示 **书签标记**
   - 可能是图标 (📌) 或彩色矩形框
3. 鼠标悬停在标记上应显示书签标题/摘要
4. 点击标记应触发跳转或展开详情

**验证点**:
- ✅ 书签标记正确显示在 PDF 上
- ✅ 位置准确对应书签坐标
- ✅ 悬停/点击交互正常

### 场景 12: 移动端响应式
**预期结果**: 在小屏幕上布局自适应

1. 打开浏览器开发者工具 (F12)
2. 切换到移动设备模拟 (Ctrl+Shift+M / Cmd+Shift+M)
3. 选择 iPhone 或 Android 设备尺寸

**验证点**:
- ✅ 书签/聊天面板变为全屏覆盖
- ✅ 显示浮动按钮 (书签 📖 + 聊天 💬)
- ✅ 关闭按钮可正常工作
- ✅ PDF 可正常浏览

## 问题排查

### 问题 1: 书签面板不显示
**可能原因**:
- 书签按钮被隐藏或点击无响应
- BookmarkPanel 组件未正确导入

**排查步骤**:
1. 打开浏览器控制台查看错误
2. 检查 Network 面板,确认 GET `/bookmarks?document_id=...` 请求成功
3. 检查 React 组件树 (React DevTools)

### 问题 2: "生成书签"按钮不出现
**可能原因**:
- 文本选择事件未正确传递
- ChatPanel 未收到 `selectedText` prop

**排查步骤**:
1. 选中文本后,在控制台查看是否有 `onTextSelected` 日志
2. 检查 ChatPanel 组件的 props (React DevTools)
3. 确认 `selectedText` 和 `selectedTextPosition` 有值

### 问题 3: 书签创建失败
**可能原因**:
- 后端 API 错误
- 认证问题 (如需要登录)
- 请求参数格式错误

**排查步骤**:
1. 打开 Network 面板,查看 POST `/bookmarks/generate` 请求
2. 检查请求体 (Request Payload)
3. 查看响应状态码和错误消息
4. 检查后端日志 (`backend/logs/intellipdf_*.log`)

### 问题 4: 分块边界不显示
**可能原因**:
- `chunks` 数据未正确传递到 PDFViewerEnhanced
- `showChunks` 状态未切换

**排查步骤**:
1. 在控制台输入: `document.querySelectorAll('[data-chunk-id]')` 检查分块元素
2. 检查 React DevTools 中 PDFViewerEnhanced 的 `chunks` prop
3. 确认 GET `/documents/{id}/chunks` 请求成功

### 问题 5: 快捷键提示遮挡发送按钮
**可能原因**:
- PDF 查看器的快捷键提示面板 z-index 过高

**解决方案**:
1. 在 PDFViewerEnhanced.tsx 中找到快捷键提示面板
2. 修改其 CSS: `z-index: 10` (确保低于聊天面板的 z-20)
3. 或修改定位: `bottom-4 left-4` → `top-4 left-4`

## API 端点参考

### 书签相关 API
- `GET /api/v1/bookmarks?document_id={id}&limit=100` - 获取书签列表
- `POST /api/v1/bookmarks/generate` - AI 生成书签
- `GET /api/v1/bookmarks/{bookmark_id}` - 获取单个书签
- `PUT /api/v1/bookmarks/{bookmark_id}` - 更新书签
- `DELETE /api/v1/bookmarks/{bookmark_id}` - 删除书签
- `POST /api/v1/bookmarks/search` - 搜索书签

### 其他相关 API
- `GET /api/v1/documents/{id}` - 获取文档信息
- `GET /api/v1/documents/{id}/chunks` - 获取分块数据
- `POST /api/v1/documents/{id}/chat` - AI 对话

## 预期测试结果总结

### ✅ 应该正常工作的功能
1. PDF 浏览 (翻页、缩放)
2. 书签面板开关
3. 文本选择检测
4. AI 生成书签 (通过"生成书签"按钮)
5. 书签列表显示
6. 书签跳转 (页码)
7. 书签编辑和删除
8. 书签搜索和排序
9. AI 聊天对话

### ⚠️ 可能需要调整的功能
1. 书签精确位置跳转 (需要实现滚动逻辑)
2. 书签覆盖层显示 (取决于 PDFViewerEnhanced 实现)
3. 分块边界可视化 (需要确认 chunks 数据格式)
4. 快捷键提示面板位置 (可能需要调整 z-index)

### ❌ 已知限制
1. 不支持多页选择 (文本选择仅限单页)
2. 不支持手动创建书签 (必须通过 AI 生成)
3. 书签标签系统未完全实现 (可编辑但无 UI 管理)

## 下一步工作

根据测试结果:
1. 修复发现的 bug
2. 完善书签精确跳转 (滚动到具体坐标)
3. 优化 UI/UX (如加载状态、错误提示)
4. 添加书签手动创建功能 (可选)
5. 实现书签标签管理 (可选)
6. 性能优化 (大量书签的虚拟滚动)

## 测试报告模板

```markdown
### 测试人员: [姓名]
### 测试时间: [日期时间]
### 浏览器: [Chrome/Firefox/Safari] [版本]

| 测试场景                  | 状态 | 备注 |
| ------------------------- | ---- | ---- |
| 场景 1: 上传文档          | ✅/❌  |      |
| 场景 2: 书签面板          | ✅/❌  |      |
| 场景 3: 文本选择+生成书签 | ✅/❌  |      |
| 场景 4: 书签列表          | ✅/❌  |      |
| 场景 5: 书签跳转          | ✅/❌  |      |
| 场景 6: 书签编辑          | ✅/❌  |      |
| 场景 7: 书签删除          | ✅/❌  |      |
| 场景 8: 搜索排序          | ✅/❌  |      |
| 场景 9: AI 对话           | ✅/❌  |      |
| 场景 10: 分块边界         | ✅/❌  |      |
| 场景 11: 书签覆盖层       | ✅/❌  |      |
| 场景 12: 移动端适配       | ✅/❌  |      |

**发现的问题**:
1. [问题描述]
2. [问题描述]

**建议改进**:
1. [建议内容]
2. [建议内容]
```

---
**注意**: 由于 ChatPanel 的导入错误可能需要先解决,如果前端编译失败,请检查:
1. `frontend/src/components/ChatPanel.tsx` 文件是否存在
2. 是否有 TypeScript 编译错误
3. 清除缓存: `cd frontend && rm -rf node_modules/.vite && npm run dev`
