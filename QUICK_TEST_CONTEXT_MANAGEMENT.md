# 快速测试 - 对话上下文管理功能

## 测试环境
```powershell
# 终端1: 启动后端
cd D:\IntelliPDF\backend
.\venv\Scripts\Activate.ps1
python main.py

# 终端2: 启动前端  
cd D:\IntelliPDF\frontend
npm run dev
```

访问: http://localhost:5173

## 核心测试流程

### 测试1: 基本对话上下文 ✅

**步骤**:
1. 打开Linux教程.pdf
2. 滚动到第160页
3. **选中文字**: "为 find_file()和 find_path()命令指定搜索路径..."
4. **点击"AI提问"按钮** (⚠️ 必须点击！)
5. 验证聊天面板打开
6. 验证话题区域显示:
   ```
   💬 当前话题  0 条对话  第 160 页
   为 find_file()和 find_path()命令指定搜...
   💡 当前对话都围绕这段文本展开
   ```

**预期结果**:
- ✅ 话题区域显示在输入框上方
- ✅ 显示蓝紫色渐变背景
- ✅ 显示正确的页码(160)
- ✅ 显示选中文字的前两行
- ✅ 对话数量为0

### 测试2: 进行话题对话 ✅

**步骤**:
1. 在输入框输入: "这个命令是做什么的？"
2. 点击发送
3. 等待AI回答
4. 验证话题区域更新为"1 条对话"
5. 再次输入: "它有什么参数？"
6. 点击发送
7. 验证话题区域更新为"2 条对话"

**预期结果**:
- ✅ 对话数量每次+1
- ✅ 话题区域始终显示
- ✅ "生成书签"按钮出现在右上角
- ✅ 按钮显示"生成书签 (2)"

### 测试3: 生成话题书签 ✅

**步骤**:
1. 完成至少2轮对话
2. 点击右上角"生成书签 (2)"按钮
3. 等待生成完成
4. 查看书签面板

**预期结果**:
- ✅ 显示"书签生成成功！"提示
- ✅ 书签面板出现新书签
- ✅ 书签包含选中文字
- ✅ 书签的AI摘要基于2轮对话
- ✅ 话题区域仍然保留（可继续对话）

### 测试4: 切换话题 ✅

**步骤**:
1. 当前有话题且有对话
2. 选中**不同的文字**: "cmake命令..."
3. **点击"AI提问"按钮**
4. 验证话题区域更新

**预期结果**:
- ✅ 话题区域显示新文字
- ✅ 对话数量重置为0
- ✅ "生成书签"按钮消失（因为新话题还没对话）
- ✅ 历史对话保留但不在当前话题内

### 测试5: 手动开始新话题 ✅

**步骤**:
1. 当前有话题且有对话
2. 点击话题区域右侧的"开始新话题"链接
3. 验证话题区域消失

**预期结果**:
- ✅ 话题区域消失
- ✅ "生成书签"按钮消失
- ✅ 历史对话保留
- ✅ 输入框placeholder恢复为"输入您的问题..."

## 边界情况测试

### 边界1: 仅选中文字不点按钮 ❌

**步骤**:
1. 选中文字
2. **不点击任何按钮**，直接点击其他地方
3. 验证话题区域**不出现**

**预期**: ❌ 话题区域不应出现

### 边界2: 点击高亮而非AI提问 ❌

**步骤**:
1. 选中文字
2. 点击"高亮"按钮（不是"AI提问"）
3. 验证话题区域**不出现**

**预期**: ❌ 话题区域不应出现

### 边界3: 没有话题但尝试生成书签 ❌

**步骤**:
1. 确保没有话题上下文
2. 尝试查找"生成书签"按钮

**预期**: ❌ 按钮不存在/不可见

### 边界4: 话题对话为0 ❌

**步骤**:
1. 点击"AI提问"设置话题
2. **不发送任何消息**
3. 查找"生成书签"按钮

**预期**: ❌ 按钮不存在/不可见

## 控制台调试

### 检查话题上下文
```javascript
// 在浏览器控制台执行
// 注意: 需要React DevTools查看组件状态
```

### 手动触发AI提问
```javascript
// 模拟点击AI提问
window.dispatchEvent(new CustomEvent('aiQuestion', { 
  detail: {
    documentId: 'your-doc-id',
    page_number: 160,
    selected_text: '测试文本',
    position: { x: 100, y: 200, width: 150, height: 20 },
    action: 'set_context'
  } 
}));
```

## 常见问题排查

### Q1: 话题区域不出现
**排查**:
1. 确认点击了"AI提问"按钮（不是其他按钮）
2. 检查浏览器控制台是否有错误
3. 验证selectedText和selectedTextPosition是否有值

### Q2: 对话数量不更新
**排查**:
1. 确认对话确实发送成功
2. 检查messages数组是否增长
3. 验证topicStartIndex是否正确设置

### Q3: 生成书签按钮不显示
**排查**:
1. 确认topicContext存在
2. 确认messages.length > topicStartIndex
3. 检查条件: `topicContext && messages.length > topicStartIndex`

### Q4: 切换话题不自动开始新话题
**排查**:
1. 确认选中了不同的文字
2. 确认点击了"AI提问"按钮
3. 检查useEffect依赖是否正确

## 性能测试

### 大量对话
```
1. 在一个话题下进行20轮对话
2. 验证界面响应流畅
3. 验证生成书签时间合理（<5秒）
```

### 快速切换话题
```
1. 连续选择5段不同文字
2. 每次都点击"AI提问"
3. 验证话题切换正确
4. 验证无内存泄漏
```

## 成功标准

全部测试通过的标准:
- ✅ 所有5个核心测试通过
- ✅ 所有4个边界情况按预期工作
- ✅ 至少3个常见问题能够排查解决
- ✅ 性能测试无明显卡顿

## 测试记录表

| 测试项         | 状态 | 备注 |
| -------------- | ---- | ---- |
| 基本对话上下文 | ⬜    |      |
| 进行话题对话   | ⬜    |      |
| 生成话题书签   | ⬜    |      |
| 切换话题       | ⬜    |      |
| 手动开始新话题 | ⬜    |      |
| 边界1          | ⬜    |      |
| 边界2          | ⬜    |      |
| 边界3          | ⬜    |      |
| 边界4          | ⬜    |      |

填写说明:
- ⬜ 未测试
- ✅ 通过
- ❌ 失败
- ⚠️ 部分通过

---

**测试完成后，请填写以上表格并报告结果！**
