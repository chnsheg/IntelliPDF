# 前端标注功能完整测试指南

## 测试前准备

### 1. 启动服务
```powershell
# 终端 1: 启动后端
cd D:\IntelliPDF\backend
.\venv\Scripts\Activate.ps1
python main.py

# 终端 2: 启动前端
cd D:\IntelliPDF\frontend
npm run dev
```

### 2. 打开浏览器
- 访问: http://localhost:5173
- 打开开发者工具 (F12) → Console 标签页
- 保持控制台可见以查看调试信息

## 测试步骤

### 测试 1: 创建矩形标注
**目的**: 验证图形标注创建和显示

1. 点击文档列表中的任意 PDF
2. 点击工具栏的 **「矩形」** 按钮
3. 在 PDF 页面上按住鼠标左键并拖拽
4. 松开鼠标完成绘制

**预期结果**:
- ✅ 绘制过程中显示实时预览（蓝色半透明矩形）
- ✅ 松开鼠标后矩形立即显示
- ✅ 控制台输出: `Shape annotation created successfully`
- ✅ 矩形保持在页面上可见

**如果失败**:
- 检查控制台是否有错误
- 检查网络标签页，确认 POST /api/v1/annotations 返回 200/201

---

### 测试 2: 选中标注
**目的**: 验证标注选择功能

1. 点击刚创建的矩形

**预期结果**:
- ✅ 控制台输出: `DraggableAnnotation: mouseDown event`
- ✅ 控制台输出: `Annotation selected: <ID>`
- ✅ 矩形周围显示蓝色虚线边框
- ✅ 四个角出现蓝色调整句柄

**如果失败 (显示 `Annotation selected: null`)**:
- 检查控制台输出: `Checking annotations for hit`
- 查看是否有 `hasGeometry=true` 的标注
- 检查点击位置是否正确: `Click position: { x, y }`

---

### 测试 3: 拖拽移动标注
**目的**: 验证拖拽功能和实时预览

1. 确保矩形已选中（有蓝色边框）
2. 在矩形内部按住鼠标左键
3. 拖动鼠标到新位置
4. 松开鼠标

**预期结果**:
- ✅ 拖拽过程中显示半透明蓝色背景
- ✅ 矩形跟随鼠标移动
- ✅ 松开后矩形保持在新位置
- ✅ 控制台输出: `Annotation moved: <ID> {新坐标}`

**边界测试**:
- 尝试拖拽到页面边缘外 → 矩形应该被限制在页面内

---

### 测试 4: 调整标注大小
**目的**: 验证调整大小功能

1. 选中矩形（四个角有蓝色句柄）
2. 将鼠标移动到 **右下角** 的蓝色句柄上
3. 鼠标指针应变为调整大小图标 (↘)
4. 按住并拖拽句柄
5. 松开鼠标

**预期结果**:
- ✅ 拖拽过程中实时显示新尺寸
- ✅ 松开后矩形保持新尺寸
- ✅ 控制台输出: `Annotation resized: <ID> {新几何}`

**测试所有四个角**:
- 左上角 (↖): 改变左上角位置和尺寸
- 右上角 (↗): 改变右上角位置和宽度
- 左下角 (↙): 改变左下角位置和高度
- 右下角 (↘): 只改变宽度和高度

**最小尺寸测试**:
- 尝试调整到非常小 → 应该有最小尺寸限制（约 20px）

---

### 测试 5: 创建便笺
**目的**: 验证便笺工具

1. 点击工具栏的 **「便笺」** 按钮
2. 页面顶部应显示黄色提示: "点击页面放置便笺"
3. 点击 PDF 页面的任意位置

**预期结果**:
- ✅ 点击位置显示编辑弹出框
- ✅ 弹出框包含文本框和颜色选择器
- ✅ 5 种颜色可选: 黄、橙、绿、蓝、紫

**编辑便笺**:
1. 在文本框中输入内容: "这是测试便笺"
2. 选择不同的颜色
3. 点击 **「保存」** 按钮

**预期结果**:
- ✅ 弹出框关闭
- ✅ 控制台输出: `Note saved successfully`
- ✅ 便笺图标显示在点击位置
- ✅ 图标颜色与选择的颜色一致
- ✅ 鼠标悬停在图标上显示内容预览

---

### 测试 6: 创建圆形和箭头
**目的**: 验证其他图形工具

**圆形**:
1. 点击 **「圆形」** 按钮
2. 在页面上拖拽绘制圆形
3. 验证圆形立即显示

**箭头**:
1. 点击 **「箭头」** 按钮
2. 点击起点，移动鼠标，再点击终点
3. 验证箭头立即显示

---

### 测试 7: 撤销和重做
**目的**: 验证历史管理功能

1. 确保已创建多个标注
2. 按 **Ctrl+Z** (撤销)

**预期结果**:
- ✅ 最后创建的标注消失
- ✅ 控制台输出: `Undo successful`
- ✅ 页面刷新显示更新后的标注列表

3. 按 **Ctrl+Y** (重做)

**预期结果**:
- ✅ 刚才消失的标注重新出现
- ✅ 控制台输出: `Redo successful`

**测试撤销移动**:
1. 拖拽一个标注到新位置
2. 按 **Ctrl+Z**
3. 标注应该回到原位置

**测试撤销调整大小**:
1. 调整一个标注的大小
2. 按 **Ctrl+Z**
3. 标注应该恢复原尺寸

---

### 测试 8: 删除标注
**目的**: 验证删除功能

**方法 1: Delete 键**
1. 选中一个标注
2. 按 **Delete** 键
3. 确认删除对话框
4. 点击「确定」

**方法 2: 工具栏按钮**
1. 选中一个标注
2. 点击工具栏的 **「删除」** 按钮

**预期结果**:
- ✅ 弹出确认对话框
- ✅ 确认后标注立即消失
- ✅ 控制台输出: `Annotation deleted: <ID>`

---

### 测试 9: 缩放和标注
**目的**: 验证标注在不同缩放级别下的显示

1. 创建一个矩形标注
2. 使用缩放控件放大 (150%, 200%)
3. 验证标注跟随缩放
4. 尝试在放大状态下拖拽和调整大小
5. 缩小 (50%, 75%)
6. 验证标注仍然可交互

---

### 测试 10: 多页面标注
**目的**: 验证标注在不同页面的独立性

1. 在第 1 页创建标注
2. 切换到第 2 页
3. 在第 2 页创建标注
4. 切换回第 1 页
5. 验证第 1 页的标注仍然存在
6. 切换到第 2 页
7. 验证第 2 页的标注独立显示

---

## 常见问题诊断

### 问题 1: 标注创建后不显示
**症状**: 控制台显示创建成功，但页面上看不到标注

**检查项**:
1. 控制台是否有错误？
2. Network 标签页中 POST 请求是否成功？
3. 后续是否有 GET /annotations 请求？
4. annotations 状态是否更新？（在 React DevTools 中检查）

**解决方案**:
- 刷新页面重新加载标注
- 检查 `handleShapeComplete` 是否调用了重新加载

### 问题 2: 无法选中标注
**症状**: 点击标注后控制台显示 `Annotation selected: null`

**检查项**:
1. 控制台输出 `DraggableAnnotation: mouseDown event`
2. `annotationsCount` 是否 > 0？
3. `hasGeometry` 数量是否 > 0？
4. 点击位置是否在标注内？
5. 碰撞检测结果 `hit=true` 的标注？

**解决方案**:
- 确认标注有 `geometry` 属性
- 检查坐标转换是否正确
- 验证 DraggableAnnotation 的 `pointer-events-auto` 是否生效

### 问题 3: 拖拽无响应
**症状**: 选中标注后无法拖拽

**检查项**:
1. 标注是否已选中（有蓝色边框）？
2. 鼠标指针是否变为 "grab" 图标？
3. 控制台是否有 `isDragging` 相关日志？

### 问题 4: 调整大小无效
**症状**: 看到调整句柄但无法拖拽

**检查项**:
1. 句柄是否有 `pointer-events-auto`？
2. 鼠标指针是否变为调整大小图标？
3. 是否在绘图模式中（工具栏按钮高亮）？

---

## 性能测试

### 大量标注测试
1. 创建 20+ 个标注
2. 验证页面渲染流畅
3. 测试选择和拖拽性能

### 内存泄漏测试
1. 创建 10 个标注
2. 全部删除
3. 重复 5 次
4. 检查浏览器内存占用

---

## 测试完成检查清单

- [ ] 矩形工具可用
- [ ] 圆形工具可用
- [ ] 箭头工具可用
- [ ] 便笺工具可用
- [ ] 标注立即显示
- [ ] 标注可选中
- [ ] 拖拽移动正常
- [ ] 调整大小正常
- [ ] 边界限制有效
- [ ] 最小尺寸限制有效
- [ ] Ctrl+Z 撤销正常
- [ ] Ctrl+Y 重做正常
- [ ] Delete 删除正常
- [ ] 缩放后标注正常
- [ ] 多页面标注独立
- [ ] 无控制台错误
- [ ] 刷新后标注持久化

---

## 测试结果报告模板

```
测试日期: ____________________
测试人员: ____________________
浏览器版本: __________________

通过的测试 (✅):


失败的测试 (❌):


发现的 Bug:


性能问题:


建议改进:

```
