# 快速测试指南 - 对话上下文管理恢复后

## 测试前准备

### 1. 启动后端
```powershell
cd D:\IntelliPDF\backend
.\start.bat
```

### 2. 启动前端
```powershell
cd D:\IntelliPDF\frontend
npm run dev
```

### 3. 打开浏览器
访问：http://localhost:5173

## 测试步骤

### 测试 1：话题上下文基础功能

1. **上传或打开一个PDF文档**

2. **选中一段文本**
   - 用鼠标拖选PDF中的任意文本
   - 应该出现工具栏，包含：底色高亮、下划线、删除线、生成标签、AI提问

3. **点击"AI提问"按钮**
   - ✅ 聊天面板应该打开
   - ✅ 输入框上方应该出现蓝紫色渐变的"当前话题"区域
   - ✅ 显示内容应包括：
     - "📌 当前话题" 标题
     - 对话数量徽章（初始为 0 条对话）
     - 页码（如"第 3 页"）
     - 选中的文本内容（最多2行）
     - 提示文字："💡 当前对话都围绕这段文本展开"
     - 右上角有 ✕ 关闭按钮

4. **在输入框中提问**
   - 输入问题，例如："请解释这段话的意思"
   - 点击发送
   - ✅ 对话数量徽章应该更新（如"1 条对话"）

5. **继续提问多次**
   - 再问2-3个相关问题
   - ✅ 每次发送后，对话数量应该增加
   - ✅ "当前话题"区域保持显示

### 测试 2：关闭话题上下文

1. **点击话题区域右上角的 ✕ 按钮**
   - ✅ "当前话题"区域应该消失
   - ✅ 此时代表对整个文档提问，不再限定特定段落

2. **提出新问题**
   - 输入一个通用问题，如："这篇文档主要讲什么？"
   - ✅ 问题应该正常发送
   - ✅ 不会显示话题上下文

### 测试 3：切换话题

1. **选中另一段不同的文本**
   - 在PDF的另一个位置选中文本

2. **点击"AI提问"按钮**
   - ✅ "当前话题"区域重新出现
   - ✅ 显示的文本应该是新选中的内容
   - ✅ 页码应该更新为新文本所在页
   - ✅ 对话数量重置为 0

3. **进行新的对话**
   - 提出相关问题
   - ✅ 新话题的对话数量独立计数

### 测试 4：生成AI书签

1. **确保当前有话题上下文和对话**
   - 如果没有，选中文本 → 点击AI提问 → 进行2-3轮对话

2. **查看"生成AI书签"按钮**
   - ✅ 应该在话题上下文区域下方显示
   - ✅ 按钮显示对话数量，如"生成AI书签 (3条对话)"

3. **点击"生成AI书签"按钮**
   - ✅ 应该触发API调用（检查开发者工具的Network标签）
   - ✅ 请求体应包含：
     - `document_id`
     - `conversation_history`（只包含当前话题的对话）
     - `context_text`（选中的文本）
     - `page_number`

### 测试 5：来源跳转功能

1. **提出一个需要引用文档的问题**
   - 例如："文档中关于XX的内容是什么？"

2. **AI回复后，查看参考来源**
   - ✅ 应该显示来源卡片，包含：
     - 页码（如"第 5 页"）
     - 相似度百分比
     - 来源文本预览

3. **点击来源卡片**
   - ✅ PDF应该自动滚动到对应页面
   - ✅ 页码指示器应该更新

### 测试 6：边界情况

#### 6.1 空话题
- 清除所有对话
- 选中文本点击AI提问，但不发送任何消息
- ✅ "生成AI书签"按钮不应该显示

#### 6.2 快速切换
- 快速选中不同文本，多次点击AI提问
- ✅ 话题上下文应该正确更新为最后一次选中的内容

#### 6.3 页面切换
- 在有话题上下文的情况下，跳转到其他页面
- ✅ 话题上下文应该保持显示
- ✅ 页码应该显示原始话题的页码，不随当前页变化

## 预期结果总结

### ✅ 正常工作的功能
1. 选中文本 → 点击AI提问 → 显示话题上下文
2. 话题上下文显示正确信息（文本、页码、对话数）
3. 关闭按钮清除话题上下文
4. 多轮对话正确累计在同一话题下
5. 生成AI书签按钮在有对话时显示
6. 点击书签按钮调用API，只包含话题内对话
7. 点击来源卡片跳转到对应页面

### ❌ 已知问题
- 标注位置计算不正确（下一个优先级）
- 标签生成功能未完成
- 后端标注API未实现

## 调试技巧

### 查看事件流
打开浏览器开发者工具 → Console，添加事件监听：

```javascript
// 监听话题设置事件
window.addEventListener('setTopicContext', (e) => {
  console.log('setTopicContext event:', e.detail);
});

// 监听书签生成事件
window.addEventListener('generateBookmark', (e) => {
  console.log('generateBookmark event:', e.detail);
});

// 监听页面跳转事件
window.addEventListener('jumpToPage', (e) => {
  console.log('jumpToPage event:', e.detail);
});
```

### 检查状态
在 React DevTools 中：
1. 找到 ChatPanel 组件
2. 查看 hooks：
   - `topicContext` - 应该包含 text, pageNumber, position
   - `topicStartIndex` - 话题开始的消息索引
   - `messages` - 完整对话历史

### 网络请求
在 Network 标签中查看：
- `/api/v1/documents/{id}/chat` - 对话请求
- `/api/v1/bookmarks/generate` - 书签生成请求

## 如果出现问题

### 话题上下文不显示
1. 检查 PDFViewerEnhanced 是否正确触发 aiQuestion 事件
2. 确认 action='set_context'
3. 检查 DocumentViewerPage 是否触发 setTopicContext 事件

### 对话数量不更新
1. 检查 topicStartIndex 是否正确设置
2. 查看 messages 数组长度变化
3. 确认计算公式：messages.length - topicStartIndex

### 来源跳转不工作
1. 检查来源数据是否包含 page_number 或 page
2. 确认 jumpToPage 事件是否触发
3. 查看 PDFViewerEnhanced 是否监听该事件

### 书签生成失败
1. 检查 API 请求格式是否正确
2. 确认 conversation_history 只包含话题内对话
3. 查看后端日志是否有错误

## 下一步开发准备

测试通过后，可以开始：
1. **标注位置修复** - 最高优先级，用户反馈问题
2. **标签系统完善** - 实现标签面板和导航
3. **后端API** - 完成标注的持久化

记住：**每次大修改前先备份！**
